#******* Format to access Input Parameters *******
# To use variable, prefix with '$'. eg. $message
# Read more https://docs.servicenow.com/?context=CSHelp:IntegrationHub-PowerShell-Step

#******* Reserved variables available when remoting type is Run on MID
# $computer   Host IP resolved from Connection alias
# $cred       Credential Object. Credential resolved via connection alias or credential alias. This can be used in conjunction with any cmd-let which support credential parameter eg. New-PSSession -credential $cred
# $log_info   mid property "mid.property.powershell.log_info" set on instance to enable debugging. So it's a flag available to act on and add any verbose logging if they want to in their script
##########################################################################################################################################
#### 
#### Script:      DL_AddRemove_Owners.ps1                                      
#### Author:      Balázs von Bölcsházy                                            
#### Version:     1.0                                                         
#### Description: Add and remove owners to the DL
#### Approver:    
####
#### Changes:     
####
###########################################################################################################################################
Import-Module ExchangeOnlineManagement

##$AppId = "931761a8-e5a2-46c6-b602-f201b9d97e06"
##$CertificateThumbprint = "B30DF9531B799A43AD24A579969A58C8B7A2FEC8"
##$Organization = "ccuatlab.com"
try{
    Connect-ExchangeOnline -CertificateThumbPrint $CertificateThumbprint -AppID $AppId -Organization $Organization

    $errors = @()
    $ownersAdded = @()
    $ownersNotAdded = @()
    $ownersRemoved = @()
    $ownersNotRemoved = @()
    $status = 0

    # Extract Owners and Members
    $AddOwners = $addOwners -split ','
    $RemoveOwners = $removeOwners -split ','

    # Check if the Distribution List already exists
    $existingDL = Get-DistributionGroup -Identity $PrimarySmtpAddress -ErrorAction SilentlyContinue

    if ($existingDL) {

        # Get owners and extract their PrimarySMTPAddress into an array
    
        $dl = Get-DistributionGroup -Identity $PrimarySmtpAddress
        $OwnerSMTPs = $dl.ManagedBy | ForEach-Object { (Get-Recipient $_).PrimarySmtpAddress.ToString() }
        Write-Output $OwnerSMTPs
        
        #$OwnerSMTPs = Get-DistributionGroup -Identity $PrimarySmtpAddress | Get-DistributionGroupOwner

        # Add Owners to the Distribution List if any are provided

        if($addOwners){
            foreach ($Owner in $AddOwners) {
                try {
                    # Check if user not exist in the Owners list
                
                    if (-not ($OwnerSMTPs -contains $Owner)) {   
                        Set-DistributionGroup -Identity $PrimarySmtpAddress -ManagedBy @{Add="$Owner"} -ErrorAction stop
                    }
                    $ownersAdded += $Owner
            
                } catch {
                    $status = 1
                    $errorMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - Error adding $Owner $($_.Exception.Message)"
                    $errors += $errorMessage
                    $ownersNotAdded += $Owner 
                }
            }
        }

        # Remove Owners from the Distribution List if any are provided
        if($removeOwners){
            foreach ($Owner in $RemoveOwners) {
                try {
                    # Check if user exists in the group

                    if ($OwnerSMTPs -contains $Owner) {   
                        Set-DistributionGroup -Identity $PrimarySmtpAddress -ManagedBy @{Remove="$Owner"} -ErrorAction stop
                    }
                    $ownersRemoved += $Owner
                } catch {
                    $status = 1
                    $errorMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - Error removing $Owner $($_.Exception.Message)"
                    $errors += $errorMessage
                    $ownersNotRemoved += $Owner 
                }
            }
        }

        $result = @{
            ErrorMessage = $errors
            Status = $status
            AddedOwnersCount = $ownersAdded.Count
            RemovedOwnersCount = $ownersRemoved.Count
            OwnersAdded = $ownersAdded
            OwnersNotAdded = $ownersNotAdded
            OwnersRemoved = $ownersRemoved
            OwnersNotRemoved = $ownersNotRemoved
        }

    }
    else{  

        $result = @{
            ErrorMessage = "Distribution List with email $PrimarySmtpAddress doesn't exists. No action taken."
            Status = 2      
            AddedOwnersCount = 0
            RemovedOwnersCount = 0
            OwnersAdded = @()
            OwnersNotAdded = @()
            OwnersRemoved = @()
            OwnersNotRemoved = @()
        }
 
    }

    # Return result as JSON

    Write-Output ($result | ConvertTo-Json -Compress) 

}catch{
    $result = @{
        ErrorMessage = "Script execution failed. No action taken. $($_.Exception.Message)"
        Status = 1      
        AddedOwnersCount = 0
        RemovedOwnersCount = 0
        OwnersAdded = @()
        OwnersNotAdded = @()
        OwnersRemoved = @()
        OwnersNotRemoved = @()
    }
    
    # Return result as JSON

    Write-Output ($result | ConvertTo-Json -Compress)  
}
